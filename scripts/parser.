import os, json, re, csv, glob
from datetime import datetime
from bs4 import BeautifulSoup

RAW_DIR = "data_raw"
OUTPUT_DIR = "data_clean"
os.makedirs(OUTPUT_DIR, exist_ok=True)


# ========= UTILITAS =========
def now_iso():
    return datetime.utcnow().isoformat() + "Z"

def safe_slug(name):
    return re.sub(r'[^a-z0-9]+', '_', name.lower()).strip('_')


# ========= PARSING TEKS FLEXIBLE =========
def parse_text_block(text, filename):
    # Ambil artis dan judul dari nama file: "Noah - Yang Terdalam.html"
    artist, title = "", ""
    match = re.match(r"(.+?)\s*-\s*(.+?)\.[a-zA-Z]+$", filename)
    if match:
        artist = match.group(1).strip()
        title = match.group(2).strip()
    else:
        title = os.path.splitext(filename)[0]

    # Cari metadata umum
    album = re.search(r"Album[:\-]?\s*(.+)", text, re.IGNORECASE)
    release = re.search(r"(Rilis|Tahun)[:\-]?\s*(\d{4})", text, re.IGNORECASE)

    # Gabungkan lirik & chord (deteksi otomatis)
    lines = text.splitlines()
    lyric_lines = []
    for line in lines:
        if re.fullmatch(r"[A-G][#b]?m?(?:\s+[A-G][#b]?m?)*", line.strip()):
            lyric_lines.append(line.strip())
        elif line.strip():
            lyric_lines.append(line.strip())

    lirik_dengan_chord = "\n".join(lyric_lines)

    return {
        "judul_lagu": title,
        "artis": artist,
        "album": album.group(1).strip() if album else "",
        "tahun_rilis": release.group(2).strip() if release else "",
        "lirik_dengan_chord": lirik_dengan_chord,
        "sumber": filename
    }


# ========= PARSING HTML =========
def parse_html(path):
    with open(path, "r", encoding="utf-8", errors="ignore") as f:
        html = f.read()
    soup = BeautifulSoup(html, "html.parser")
    text = soup.get_text("\n", strip=True)
    return parse_text_block(text, os.path.basename(path))


# ========= PARSING TXT =========
def parse_txt(path):
    with open(path, "r", encoding="utf-8", errors="ignore") as f:
        text = f.read()
    return parse_text_block(text, os.path.basename(path))


# ========= PARSING CSV =========
def parse_csv(path):
    songs = []
    with open(path, newline='', encoding="utf-8", errors="ignore") as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            songs.append({
                "judul_lagu": row.get("judul_lagu") or row.get("title") or "",
                "artis": row.get("artis") or row.get("artist") or "",
                "album": row.get("album") or "",
                "tahun_rilis": row.get("tahun_rilis") or row.get("year") or "",
                "lirik_dengan_chord": row.get("lirik") or row.get("lyrics") or "",
                "sumber": os.path.basename(path)
            })
    return songs


# ========= MAIN PROCESS =========
def save_per_artist(song):
    artist = song["artis"] or "Unknown"
    slug = safe_slug(artist)
    path = os.path.join(OUTPUT_DIR, f"{slug}.json")

    # Baca data lama
    if os.path.exists(path):
        with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)
    else:
        data = {"artist": artist, "updated_at": now_iso(), "songs": []}

    # Cek duplikat judul
    existing_titles = [s["judul_lagu"].lower() for s in data["songs"]]
    if song["judul_lagu"].lower() not in existing_titles:
        data["songs"].append(song)

    data["updated_at"] = now_iso()

    with open(path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


def parse_all():
    files = glob.glob(os.path.join(RAW_DIR, "*"))
    for file in files:
        ext = os.path.splitext(file)[1].lower()
        try:
            if ext in [".html", ".htm"]:
                song = parse_html(file)
                save_per_artist(song)
            elif ext == ".txt":
                song = parse_txt(file)
                save_per_artist(song)
            elif ext == ".csv":
                songs = parse_csv(file)
                for s in songs:
                    save_per_artist(s)
            else:
                print(f"⚠️ Skip {file} (format tidak dikenal)")
        except Exception as e:
            print(f"❌ Error parsing {file}: {e}")

    print("✅ Semua file berhasil diproses.")


if __name__ == "__main__":
    parse_all()
